<div class="container mx-auto px-4 py-8">
  <header class="mb-8">
    <h1 class="text-3xl font-bold text-gray-800">Caixa</h1>
    <p class="text-gray-600">Sistema de faturamento do pet shop</p>
  </header>

  @if (currentStep() === 1) {
  <div class="bg-white rounded-lg shadow-md p-6 mb-6">
    <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
      <span
        class="bg-blue-600 text-white rounded-full w-8 h-8 flex items-center justify-center mr-3"
        >1</span
      >
      Buscar Cliente
    </h2>

    <div class="flex items-center gap-6 mb-4">
      <label class="flex items-center cursor-pointer">
        <input
          type="radio"
          [formControl]="searchTypeControl"
          value="name"
          class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500"
        />
        <span class="ml-2 text-sm text-gray-700 font-medium">Nome</span>
      </label>
      <label class="flex items-center cursor-pointer">
        <input
          type="radio"
          [formControl]="searchTypeControl"
          value="cpf"
          class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500"
        />
        <span class="ml-2 text-sm text-gray-700 font-medium">CPF</span>
      </label>
    </div>

    <div class="flex flex-col md:flex-row gap-4">
      <div class="flex-grow">
        <label for="customerSearch" class="block text-sm font-medium text-gray-700 mb-1">
          {{ searchTypeControl.value === 'name' ? 'Nome do cliente' : 'CPF do cliente' }}
        </label>
        <div class="relative">
          <input
            type="text"
            id="customerSearch"
            [formControl]="searchControl"
            (keyup.enter)="handleSearch()"
            [mask]="searchTypeControl.value === 'cpf' ? '000.000.000-00' : ''"
            [placeholder]="
              searchTypeControl.value === 'cpf' ? 'Digite o CPF' : 'Digite o nome do cliente'
            "
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-600 focus:border-blue-600"
          />
          <fa-icon [icon]="faSearch" class="absolute right-3 top-3 text-gray-400"></fa-icon>
        </div>
        <div
          *ngIf="searchTypeControl.value === 'name' && searchControl.hasError('leadingSpace')"
          class="text-red-600 text-sm mt-1"
        >
          O nome não pode começar com espaço.
        </div>
        <div
          *ngIf="searchTypeControl.value === 'name' && searchControl.hasError('containsNumber')"
          class="text-red-600 text-sm mt-1"
        >
          O nome não pode conter números.
        </div>
      </div>
      <div class="flex items-end">
        <button
          (click)="handleSearch()"
          class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium transition duration-200"
        >
          Buscar
        </button>
      </div>
    </div>

    <div class="mt-4 border-t pt-4">
      @if (searchResults().length > 0) {
      <p class="text-sm text-gray-600 mb-2">Selecione um cliente:</p>
      <div class="space-y-2">
        @for (customer of searchResults(); track customer.id) {
        <div
          (click)="selectCustomer(customer)"
          class="p-3 border rounded-lg hover:bg-gray-100 cursor-pointer flex justify-between items-center"
        >
          <span class="font-medium text-gray-800">{{ customer.name }}</span>
          <span class="text-sm text-gray-500">
            {{ customer.cpf ?? '' | mask : '000.000.000-00' }}
          </span>
        </div>
        }
      </div>
      } @if (hasSearched() && searchResults().length === 0) {
      <div class="text-center py-4">
        <p class="text-gray-600">Nenhum cliente encontrado com o termo informado.</p>
      </div>
      }
    </div>
  </div>
  } @if (currentStep() === 2) {
  <div class="bg-white rounded-lg shadow-md p-6 mb-6">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-semibold text-gray-800 flex items-center">
        <span
          class="bg-blue-600 text-white rounded-full w-8 h-8 flex items-center justify-center mr-3"
          >2</span
        >
        <span
          >Selecionar Serviços para Faturar de:
          <span class="text-blue-600">{{ selectedCustomer()?.name }}</span>
        </span>
      </h2>
      <button
        (click)="backToSearch()"
        class="flex items-center text-sm text-gray-600 hover:text-blue-600 font-medium transition"
      >
        <fa-icon [icon]="faArrowLeft" class="mr-2"></fa-icon>
        Voltar para a busca
      </button>
    </div>

    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th scope="col" class="w-12 px-6 py-3 text-left"></th>
            <th
              scope="col"
              class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
            >
              Data
            </th>
            <th
              scope="col"
              class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
            >
              Pet
            </th>
            <th
              scope="col"
              class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
            >
              Serviço
            </th>
            <th
              scope="col"
              class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider"
            >
              Valor
            </th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          @for (app of faturableAppointments(); track app.id) {
          <tr class="hover:bg-gray-50">
            <td class="px-6 py-4">
              <input
                type="checkbox"
                class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                [checked]="selectedAppointmentIds().has(app.id)"
                (change)="toggleSelection(app.id)"
              />
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
              {{ app.startDateTime | date : 'dd/MM/yyyy HH:mm' }}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
              {{ app.pet.name }}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
              {{ app.service.name }}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 text-right">
              {{ app.service.price | currency : 'BRL' }}
            </td>
          </tr>
          }
        </tbody>
      </table>

      @if (faturableAppointments().length === 0) {
      <div class="text-center py-8">
        <p class="text-gray-500">
          Este cliente não possui serviços concluídos pendentes de faturamento.
        </p>
      </div>
      }
    </div>

    <div class="mt-6 flex flex-col md:flex-row justify-between items-center border-t pt-4">
      <div class="mb-4 md:mb-0">
        <span class="text-gray-600">Total Selecionado:</span>
        <span class="ml-2 text-xl font-bold text-blue-600">{{
          totalSelected() | currency : 'BRL'
        }}</span>
      </div>
      <button
        (click)="generateInvoice()"
        class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium transition duration-200 disabled:opacity-50"
        [disabled]="isInvoiceButtonDisabled()"
      >
        Gerar Fatura
      </button>
    </div>
  </div>
  } @if (currentStep() === 3) {
  <div class="bg-white rounded-lg shadow-md p-6 mb-6">
    @if (createdInvoice(); as invoice) {
    <div class="flex flex-wrap justify-between items-center border-b pb-3 mb-4 gap-2">
      <h2 class="text-xl font-semibold text-gray-800 flex items-center">
        <span
          class="bg-blue-600 text-white rounded-full w-8 h-8 flex items-center justify-center mr-3"
          >3</span
        >
        <span
          >Fatura <span class="text-blue-600">#{{ invoice.id }}</span></span
        >
      </h2>
      <span class="bg-yellow-100 text-yellow-800 text-sm font-semibold px-3 py-1 rounded-full">
        Aguardando Pagamento
      </span>
    </div>

    <p class="mb-4 text-gray-600">
      Cliente: <span class="font-medium text-gray-800">{{ invoice.customer.name }}</span>
    </p>

    <h3 class="text-lg font-medium text-gray-800 mb-2">Itens Faturados</h3>
    <div class="divide-y divide-gray-200">
      @for (app of invoice.appointments; track app.id) {
      <div class="py-3 flex justify-between">
        <div>
          <p class="font-medium text-gray-800">{{ app.service.name }}</p>
          <p class="text-sm text-gray-500">
            {{ app.pet.name }} - {{ app.startDateTime | date : 'dd/MM/yyyy' }}
          </p>
        </div>
        <div class="text-gray-800 font-medium">{{ app.service.price | currency : 'BRL' }}</div>
      </div>
      }
    </div>

    <div class="mt-6 pt-4 border-t">
      <div class="flex justify-between items-center">
        <span class="text-gray-600 font-medium">VALOR TOTAL:</span>
        <span class="text-2xl font-bold text-blue-600">{{
          invoice.totalAmount | currency : 'BRL'
        }}</span>
      </div>
    </div>

    <div class="mt-8 flex flex-col sm:flex-row justify-end gap-3">
      <button
        (click)="backToSearch()"
        class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50 transition duration-200"
      >
        Voltar (Novo Atendimento)
      </button>
      <button
        (click)="confirmPayment()"
        class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg font-medium transition duration-200"
      >
        Confirmar e Marcar como Pago
      </button>
    </div>
    } @else {
    <p>Carregando fatura...</p>
    }
  </div>
  }
</div>
